---
title: "PML: Weight Lifting Exercise"
output: html_document
---
###Background

In this project, we will use data from accelerometers on the belt, forearm, arm, and dumbell of 6 participants. They were asked to perform barbell lifts correctly and incorrectly in 5 different ways. More information is available from the website here: http://groupware.les.inf.puc-rio.br/har. 

Our goal is to predict in which one of the 5 ways that participants performed in 20 separate qualitative measurements.


###Data 


The training data for this project are available here: 

https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv

The test data are available here: 

https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv

###Load required libraries
```{r}
library(caret)
library(randomForest)
library(rattle)
library(sqldf)
library(doBy)

```

###Read data

```{r}
pmltraining <- read.csv(url("http://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"))
pmltesting <- read.csv(url("http://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"))
#pmltraining1 <- read.csv("/media/S/Temp/pml-training.csv")
#pmltesting1 <- read.csv("/media/S/Temp/pml-testing.csv")

```

###Data cleaning and partition for validation
```{r}
dim(pmltraining);dim(pmltesting)
```

We first check the data quality in training dataset. We first convert '#DIV/0!' in a numeric field to 'NA', then use function `colSums` to identify columns that contains missing values. 

These columns together with a number of columns of timestamps are removed from both training set. The same cleaning rule is then applied to the testing dataset.

(We also tried to remove missing record by rows but it turned out to be inapplicable because 98% of data would have been removed.)

We also separated the testing dataset into testing and validation partitions. Set seed so the same result can be reproduced.
```{r}
# To see the missing values
# summary(pmltraining)

# use training data only to remove NA columns
prePro<-pmltraining
prePro[prePro=='#DIV/0!']<-NA
nona<-colSums(is.na(prePro)) == 0
nona[c(1,3:5)]<-FALSE

#set.seed(1234)
mlData<-pmltraining[,nona]
inTrain<-createDataPartition(y=mlData$classe,p=0.5,list=F)
training<-mlData[inTrain,]
validating<-mlData[-inTrain,]

#do the same variable selection on testing dataset
testing<-pmltesting[,nona]
```

###Exploratory plots

Don't know what plots are appropriate yet ...
```{r}
toPlot<-sqldf('select
              classe,
              total_accel_belt,
              total_accel_arm,
              total_accel_dumbbell,
              total_accel_forearm
              from training ')
featurePlot(toPlot[,2:5],toPlot[,1],plot='pairs',xlab='total accel')

qplot(total_accel_belt,total_accel_arm,col=classe,data=training,
      main='Predictors by classe')
```

###Data preprocessing

Tried PCA but it didn't help - will drop from the writeup
```{r}
# to see the predictors
# names(training)
lastCol<-ncol(training)
preProc<-preProcess(training[,-c(1:6,lastCol)],method='pca',thresh=.99)
trainPC<-predict(preProc,training[,-c(1:6,lastCol)])
validPC<-predict(preProc,validating[,-c(1:6,lastCol)])
testPC<-predict(preProc,testing[,-c(1:6,lastCol)])

```


###Modeling
```{r}
# very slow!
# system.time(modFit<-train(classe~.,method='rf',data=trainPC,prox=T))
# modFit$finalModel

system.time(PCFit<-randomForest(training$classe~.,data=trainPC,ntree=500))
PCFit
system.time(modFit<-randomForest(classe~.,data=training,ntree=500))
modFit

```

###Validation
```{r}
pred<-predict(PCFit,validPC)
table(pred,validating$classe)
pred<-predict(modFit,validating)
table(pred,validating$classe)
```

###Testing
Notice that the variable 'new_window' in testing dataset doesn't have the same levels as that in the training data. We have to add a new level 'yes' into it before it can be used in the model fit from the training model.
```{r}
levels(testing$new_window)<-c(levels(testing$new_window),'yes')
pred<-predict(modFit,testing)
pred

##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 
##  B  A  B  A  A  E  D  B  A  A  B  C  B  A  E  E  A  B  B  B 
```

[Here is the GitHub page.](http://lisun7170.github.io/pml/coursera_wleproj.html)

